---
- name: prepare dashboard directory
  file:
    name: /etc/kubernetes/manifests/addon/dashboard
    state: directory

- name: prepare dashboard deployment file
  template:
    src: dashboard/{{ item }}.j2
    dest: /etc/kubernetes/manifests/addon/dashboard/{{ item }}
  with_items:
    - kubernetes-dashboard.yaml
    - admin-user-sa-rbac.yaml

- name: apply dashboard deployment
  shell: kubectl apply -f /etc/kubernetes/manifests/addon/dashboard/

- name: waiting dashboard ready
  shell: >-
    set -o pipefail
    && kubectl get pod -n kubernetes-dashboard
    | tail -n +2
    | awk '{print $3}'
  register: dashboard_status
  # https://stackoverflow.com/questions/42673045/ansible-when-statements-should-not-include-jinja2-templating-delimiters
  until: dashboard_status.stdout_lines|unique|list == ['Running']
  retries: 30
  delay: 20

- name: get admin-user access token
  vars:
    # host: "{{ groups['k8s_master'][0] }}"
    host: "{{ groups.k8s_master.0 }}"
    address: "https://{{ APISERVER_VIP|default(hostvars[host]['ansible_host'], true) }}:30443/"
  debug:
    msg:
      - "Dashboard listen on {{ address }}"
      - "Use following command to get access token of admin-user."
      - "kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret|grep admin-user|awk '{print $1}')"
