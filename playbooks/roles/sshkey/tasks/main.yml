---
- name: create ssh config directory
  file:
    path: ~/.ssh
    state: directory

- name: generate rsa key pair
  openssh_keypair:
    comment: cluster internal auth
    owner: root
    path: ~/.ssh/id_rsa
    state: present
    type: rsa
    size: 2048

- name: cat pub key
  shell: cat ~/.ssh/id_rsa.pub
  register: internal_key_result

- name: set fact pub key
  # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/set_fact_module.html
  set_fact:
    internal_pub_key: "{{ internal_key_result.stdout }}"

# - name: debug internal_pub_key
#   debug:
#     msg: "internal_pub_key: {{ internal_pub_key }}"

- name: copy pub key to managed nodes
  # https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html
  vars:
    # https://www.cnblogs.com/didispace/p/12524194.html
    # https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.html
    # https://docs.ansible.com/ansible/latest/user_guide/playbooks_vars_facts.html

    # What is "-%}"" for in a jinja template?
    # https://jinja.palletsprojects.com/en/latest/templates/#whitespace-control
    # https://picostitch.com/blog/2017/01/21-the-magic-dash-in-jinja-template-block/
    # http://jinja.quantprogramming.com/
    hosts: |-
      {%- set hosts = [] -%}
      {%- for host in groups['all'] -%}
        {{ hosts.append(hostvars[host]['internal_pub_key'] | trim) }}
      {%- endfor -%}
      {{ hosts }}
  # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/lineinfile_module.html
  lineinfile:
    path: ~/.ssh/authorized_keys
    insertafter: EOF
    line: "{{ item }}"
    create: true
    state: present
  # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/items_lookup.html
  with_items: "{{ hosts }}"
